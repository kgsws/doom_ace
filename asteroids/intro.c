// kgsws' Doom ACE
#include "engine.h"
#include "utils.h"
#include "defs.h"
#include "intro.h"
#include "game.h"

#include "intro_sound.h"

#define INTRO_XOFFSET	(-FRACUNIT * 2100)
#define INTRO_YOFFSET	(-FRACUNIT * 1350)

typedef struct
{
	uint32_t unused[3];
	fixed_t x, y, z;
} dmobj_t;

static point_t logo_lines[] =
{
	// 'k'
	{72, 0}, {72, 37},
	{72, 23}, {84, 11},
	{72, 23}, {86, 37},
	// 'g'
	{127, 15}, {122, 10},
	{122, 10}, {114, 10},
	{114, 10}, {107, 17},
	{107, 17}, {107, 30},
	{107, 30}, {114, 37},
	{114, 37}, {122, 37},
	{122, 37}, {126, 34},
	{126, 34}, {126, 24},
	{126, 24}, {119, 24},
	// 's'
	{166, 15}, {162, 11},
	{162, 11}, {153, 11},
	{153, 11}, {149, 15},
	{149, 15}, {149, 21},
	{149, 21}, {166, 27},
	{166, 27}, {166, 33},
	{166, 33}, {162, 37},
	{162, 37}, {152, 37},
	{152, 37}, {147, 32},
	// 'w'
	{184, 11}, {192, 37},
	{192, 37}, {202, 11},
	{198, 11}, {209, 37},
	{209, 37}, {216, 11},
	// 's'
	{253, 15}, {249, 11},
	{249, 11}, {240, 11},
	{240, 11}, {236, 15},
	{236, 15}, {236, 21},
	{236, 21}, {253, 27},
	{253, 27}, {253, 33},
	{253, 33}, {249, 37},
	{249, 37}, {239, 37},
	{239, 37}, {234, 32},
	//
	// 'p'
	{97, 64}, {97, 85},
	{97, 67}, {101, 65},
	{101, 65}, {105, 65},
	{105, 65}, {108, 69},
	{108, 69}, {108, 75},
	{108, 75}, {105, 78},
	{105, 78}, {100, 78},
	{100, 78}, {97, 76},
	// 'r'
	{117, 64}, {117, 79},
	{117, 67}, {121, 65},
	{121, 65}, {124, 65},
	// 'e'
	{128, 71}, {139, 71},
	{139, 71}, {139, 67},
	{139, 67}, {136, 65},
	{136, 65}, {131, 65},
	{131, 65}, {128, 68},
	{128, 68}, {128, 75},
	{128, 75}, {131, 78},
	{131, 78}, {136, 78},
	{136, 78}, {139, 75},
	// 's'
	{155, 67}, {153, 65},
	{153, 65}, {148, 65},
	{148, 65}, {146, 67},
	{146, 67}, {146, 70},
	{146, 70}, {155, 73},
	{155, 73}, {155, 76},
	{155, 76}, {153, 78},
	{153, 78}, {148, 78},
	{148, 78}, {146, 76},
	// 'e'
	{175, 75}, {172, 78},
	{172, 78}, {167, 78},
	{167, 78}, {164, 75},
	{164, 75}, {164, 68},
	{164, 68}, {167, 65},
	{167, 65}, {172, 65},
	{172, 65}, {175, 67},
	{175, 67}, {175, 71},
	{175, 71}, {164, 71},
	// 'n'
	{184, 64}, {184, 79},
	{184, 67}, {188, 65},
	{188, 65}, {192, 65},
	{192, 65}, {194, 67},
	{194, 67}, {194, 79},
	// 't'
	{203, 59}, {203, 76},
	{203, 76}, {206, 78},
	{206, 78}, {210, 78},
	{200, 65}, {210, 65},
	// 's'
	{215, 76}, {217, 78},
	{217, 78}, {222, 78},
	{222, 78}, {224, 76},
	{224, 76}, {224, 73},
	{224, 73}, {215, 70},
	{215, 70}, {215, 67},
	{215, 67}, {217, 65},
	{217, 65}, {222, 65},
	{222, 65}, {224, 67},
	//
	// 'G'
	{120, 110}, {115, 105},
	{115, 105}, {106, 105},
	{106, 105}, {98, 113},
	{98, 113}, {98, 134},
	{98, 134}, {107, 143},
	{107, 143}, {115, 143},
	{115, 143}, {119, 140},
	{119, 140}, {119, 126},
	{119, 126}, {112, 126},
	// 'A'
	{129, 143}, {142, 104},
	{142, 104}, {155, 143},
	{133, 130}, {151, 130},
	// 'M'
	{165, 143}, {165, 104},
	{165, 104}, {175, 129},
	{175, 129}, {186, 104},
	{186, 104}, {186, 143},
	// 'E'
	{222, 143}, {201, 143},
	{201, 143}, {201, 104},
	{201, 104}, {221, 104},
	{201, 122}, {221, 122},
	//
	// 'I'
	{23, 159}, {23, 198},
	// 'N'
	{47, 198}, {47, 159},
	{47, 159}, {68, 198},
	{68, 198}, {68, 159},
	// 'J'
	{98, 159}, {98, 192},
	{98, 192}, {92, 198},
	{92, 198}, {83, 198},
	{83, 198}, {78, 193},
	// 'E'
	{136, 159}, {116, 159},
	{116, 159}, {116, 198},
	{116, 198}, {137, 198},
	{116, 177}, {136, 177},
	// 'C'
	{171, 193}, {166, 198},
	{166, 198}, {159, 198},
	{159, 198}, {151, 190},
	{151, 190}, {151, 167},
	{151, 167}, {158, 160},
	{158, 160}, {166, 160},
	{166, 160}, {171, 165},
	// 'T'
	{178, 160}, {208, 160},
	{193, 160}, {193, 198},
	// 'I'
	{227, 159}, {227, 198},
	// 'O'
	{258, 160}, {251, 167},
	{251, 167}, {251, 190},
	{251, 190}, {259, 198},
	{259, 198}, {264, 198},
	{264, 198}, {272, 190},
	{272, 190}, {272, 167},
	{272, 167}, {265, 160},
	{265, 160}, {258, 160},
	// 'N'
	{285, 198}, {285, 159},
	{285, 159}, {306, 198},
	{306, 198}, {306, 159}
};
#define INTRO_LINE_COUNT	(sizeof(logo_lines) / (2*sizeof(point_t)))

static point_t gameover_lines[] =
{
	// 'G'
	{112, 75}, {119, 75},
	{119, 75}, {119, 89},
	{119, 89}, {115, 92},
	{115, 92}, {107, 92},
	{107, 92}, {98, 83},
	{98, 83}, {98, 62},
	{98, 62}, {106, 54},
	{106, 54}, {115, 54},
	{115, 54}, {120, 59},
	// 'A'
	{129, 92}, {142, 53},
	{142, 53}, {155, 92},
	{133, 79}, {151, 79},
	// 'M'
	{165, 92}, {165, 53},
	{165, 53}, {175, 78},
	{175, 78}, {186, 53},
	{186, 53}, {186, 92},
	// 'E'
	{221, 53}, {201, 53},
	{201, 53}, {201, 92},
	{201, 92}, {222, 92},
	{201, 71}, {221, 71},
	//
	// 'O'
	{111, 147}, {119, 139},
	{119, 139}, {119, 116},
	{119, 116}, {112, 109},
	{112, 109}, {105, 109},
	{105, 109}, {98, 116},
	{98, 116}, {98, 139},
	{98, 139}, {106, 147},
	{106, 147}, {111, 147},
	// 'V'
	{130, 108}, {143, 147},
	{143, 147}, {155, 108},
	// 'E'
	{167, 108}, {167, 147},
	{167, 147}, {188, 147},
	{167, 126}, {187, 126},
	{167, 108}, {187, 108},
	// 'R'
	{202, 147}, {202, 108},
	{202, 129}, {213, 129},
	{202, 108}, {213, 108},
	{213, 108}, {220, 115},
	{220, 115}, {220, 125},
	{220, 125}, {213, 129},
	{213, 129}, {221, 147},
};
#define GAMEOVER_LINE_COUNT	(sizeof(gameover_lines) / (2*sizeof(point_t)))

static point_t youwin_lines[] =
{
	// 'Y'
	{125, 92}, {125, 73},
	{112, 53}, {125, 73},
	{125, 73}, {138, 53},
	// 'O'
	{148, 84}, {156, 92},
	{156, 92}, {161, 92},
	{161, 92}, {169, 84},
	{169, 84}, {169, 61},
	{169, 61}, {162, 54},
	{162, 54}, {155, 54},
	{155, 54}, {148, 61},
	{148, 61}, {148, 84},
	// 'U'
	{182, 53}, {182, 85},
	{182, 85}, {190, 93},
	{190, 93}, {195, 93},
	{195, 93}, {203, 85},
	{203, 85}, {203, 53},
	//
	// 'W'
	{111, 108}, {117, 147},
	{117, 147}, {127, 119},
	{123, 119}, {133, 147},
	{133, 147}, {139, 108},
	// 'I'
	{159, 108}, {159, 147},
	// 'N'
	{183, 147}, {183, 108},
	{183, 108}, {204, 147},
	{204, 147}, {204, 108},
};
#define YOUWIN_LINE_COUNT	(sizeof(youwin_lines) / (2*sizeof(point_t)))

static hook_t hook_list[] =
{
	// replace D_PageDrawer, kinda
	{0x0001d319, CODE_HOOK | HOOK_RELADDR_ACE, (uint32_t)game_drawer},
	// replace D_PageTicker
	{0x0002083f, CODE_HOOK | HOOK_RELADDR_ACE, (uint32_t)game_ticker},
	// replace M_Responder
	{0x0001d13a, CODE_HOOK | HOOK_RELADDR_ACE, (uint32_t)game_input},
	// terminator
	{0}
};

dmobj_t fake_mobj;
void *playermo;

uint32_t intro_start;
uint32_t intro_end;

int32_t snd_lmp;

//
// API

void intro_draw_text(uint32_t idx)
{
	point_t *point;
	uint32_t count;
	uint32_t base_color;
	uint32_t color_pulse;

	switch(idx)
	{
		default:
			point = logo_lines;
			count = INTRO_LINE_COUNT;
			base_color = 216;
			color_pulse = 0;
		break;
		case 1:
			point = gameover_lines;
			count = GAMEOVER_LINE_COUNT;
			base_color = 144;
			color_pulse = 0;
		break;
		case 2:
			point = youwin_lines;
			count = YOUWIN_LINE_COUNT;
			base_color = 160;
			color_pulse = 3;
		break;
	}

	for(uint32_t i = 0; i < count; i++)
	{
		map_line_t ml;
		uint32_t color;

		if(i < intro_start)
		{
			point += 2;
			continue;
		}

		if(i >= intro_end + 8)
			break;

		if(i >= intro_end)
			color = 96 + (i - intro_end) * 2;
		else
			color = base_color + (((*gametic + i) >> 3) & color_pulse);

		ml.a.x = INTRO_XOFFSET + ((int32_t)point->x << 22) / 5;
		ml.a.y = -((int32_t)point->y << 22) / 5 - INTRO_YOFFSET;
		point++;
		ml.b.x = INTRO_XOFFSET + ((int32_t)point->x << 22) / 5;
		ml.b.y = -((int32_t)point->y << 22) / 5 - INTRO_YOFFSET;
		point++;

		if(i >= intro_end)
		{
			ml.a.x += (-32 + (M_Random() & 63)) << FRACBITS;
			ml.a.y += (-32 + (M_Random() & 63)) << FRACBITS;
			ml.b.x += (-32 + (M_Random() & 63)) << FRACBITS;
			ml.b.y += (-32 + (M_Random() & 63)) << FRACBITS;
		}

		AM_drawMline(&ml, color);
	}
}

void intro_init()
{
	// initialize line drawing
	fake_mobj.x = 0;
	fake_mobj.y = 0;
	playermo = &fake_mobj;
	*players = &fake_mobj;
	*am_height = 200;
	AM_Start();
	*min_scale_mtof = FRACUNIT / 14;
	AM_minOutWindowScale();
	AM_doFollowPlayer();

	// animate logo
	intro_start = 0;
	intro_end = 1;

	// custom sound
	snd_lmp = W_GetNumForName("DSTINK");
	if(lumpcache[snd_lmp])
		Z_Free(lumpcache[snd_lmp]);
	lumpcache[snd_lmp] = Z_Malloc(sizeof(intro_sound), PU_CACHE, &lumpcache[snd_lmp]);
	memcpy(lumpcache[snd_lmp], intro_sound, sizeof(intro_sound));
}

__attribute((regparm(2),no_caller_saved_registers))
void intro_drawer()
{
	memset(screens0, 0, 320*200);
	V_MarkRect(0, 0, 320, 200);

	intro_draw_text(0);
}

__attribute((regparm(2),no_caller_saved_registers))
void intro_ticker()
{
	if(intro_end < 35 * 6)
	{
		intro_end++;
		if(intro_end == 75)
			S_StartSound(NULL, sfx_tink);
	} else
	{
		intro_start += 8;
		if(intro_start >= 35 * 5)
		{
			// init the game now
			intro_start = 0;
			utils_install_hooks(hook_list);
			Z_Free(lumpcache[snd_lmp]);
			game_init();
		}
	}
}

__attribute((regparm(2),no_caller_saved_registers))
int intro_input(event_t *ev)
{
	// always 'eat' the key
	return 1;
}

